# Story 1.9: Portfolio Refresh and Error Handling

## Status
Draft

## Story
**As a** DeFi user,
**I want** to refresh my portfolio data and see clear error messages when things fail,
**so that** I can get updated information and understand any connectivity issues.

## Acceptance Criteria
1. Manual refresh button that updates all portfolio data with loading indicators
2. Comprehensive error handling for RPC failures, price API failures, and network issues
3. User-friendly error messages with retry suggestions
4. Loading skeletons during data fetching with proper state management
5. Automatic retry logic for transient failures with user notification
6. Connection status indicator showing RPC and price API health

## Tasks / Subtasks
- [ ] Implement Portfolio Refresh System (AC: 1, 4)
  - [ ] Create RefreshService in `apps/api/src/services/RefreshService.ts` with coordinated refresh across all portfolio components
  - [ ] Add manual refresh endpoint to portfolio tRPC router with optimistic cache invalidation
  - [ ] Implement loading state management in `apps/web/src/stores/portfolio.ts` using Zustand
  - [ ] Create loading skeleton components in `apps/web/src/components/ui/LoadingSkeletons.tsx`
  - [ ] Add refresh button to PortfolioOverview component with loading indicators
- [ ] Build Comprehensive Error Handling System (AC: 2, 3)
  - [ ] Extend DeFiError classes in `apps/api/src/utils/errors.ts` with RPC_FAILURE, PRICE_API_FAILURE, NETWORK_ERROR codes
  - [ ] Implement error classification service that maps external API errors to user-friendly messages
  - [ ] Create error boundary components in `apps/web/src/components/ErrorBoundary.tsx` with error reporting
  - [ ] Add error message mapping utility in `packages/shared/src/utils/errorMessages.ts`
  - [ ] Implement toast notification system with retry action buttons
- [ ] Create Automatic Retry Logic (AC: 5)
  - [ ] Build RetryManager service in `apps/api/src/services/RetryManager.ts` with exponential backoff
  - [ ] Add retry configuration for different error types (RPC: 3 attempts, Price API: 2 attempts)
  - [ ] Implement circuit breaker pattern for failing services
  - [ ] Create user notification system for retry attempts and final failures
  - [ ] Add retry button in error states with manual retry capabilities
- [ ] Implement Connection Status Monitoring (AC: 6)
  - [ ] Create HealthCheckService in `apps/api/src/services/HealthCheckService.ts` for RPC and API monitoring
  - [ ] Add health check endpoints to monitor RPC provider and price API connectivity
  - [ ] Create connection status indicator component in `apps/web/src/components/ConnectionStatus.tsx`
  - [ ] Implement real-time health status updates using tRPC subscriptions
  - [ ] Add network status detection for offline/online state management

## Dev Notes

### Previous Story Insights
From Story 1.6 (Live Token Balance Integration):
- PriceService and PortfolioAggregator services are implemented with Moralis primary and DefiLlama secondary fallback
- tRPC portfolio router exists with getPortfolio and refreshPortfolio endpoints
- RPC Batch Manager is operational for efficient blockchain data fetching
- BigInt precision handling is established for financial calculations
- Error handling patterns are partially implemented but need extension for comprehensive coverage

From Story 1.8 (LP Position Integration - Draft):
- LP Position tracking services are planned but not yet implemented
- Integration with existing portfolio aggregation system is designed
- Error handling needs to account for LP position failures as well

### Data Models
[Source: architecture/data-models.md#portfolio]
**Extended Portfolio Interface** for refresh state management:
```typescript
interface PortfolioRefreshState {
  isRefreshing: boolean;
  lastRefreshTime: Date;
  refreshStatus: 'idle' | 'refreshing' | 'success' | 'error';
  errorDetails?: {
    code: string;
    message: string;
    retryable: boolean;
    retryAttempts: number;
  };
}
```

[Source: architecture/error-handling-strategy.md#error-response-format]
**DeFi Error Extensions**:
```typescript
interface DeFiError {
  code: 'RPC_FAILURE' | 'PRICE_API_FAILURE' | 'NETWORK_ERROR' | 'RATE_LIMIT_EXCEEDED';
  message: string;
  details: {
    provider?: string;
    chainId?: number;
    retryable: boolean;
    suggestedAction: string;
  };
  timestamp: string;
  requestId: string;
}
```

### API Specifications
[Source: architecture/api-specification.md#portfolio-router]
**Extended tRPC Portfolio Router**:
- `refreshPortfolio({ userId, forceRefresh, includeLP })` - Enhanced refresh with LP positions support
- `getRefreshStatus({ userId })` - Get current refresh operation status
- `healthCheck({ includeProviders })` - Check RPC and price API connectivity
- Input validation with refresh rate limiting (max 1 refresh per 10 seconds per user)

### Component Specifications
[Source: architecture/components.md#portfolio-data-aggregator]
**Enhanced Portfolio Data Aggregator**:
- `refreshAllData(userId: string, options: RefreshOptions): Promise<RefreshResult>` - Coordinated refresh across all portfolio components
- `getRefreshStatus(userId: string): Promise<RefreshStatus>` - Current refresh operation status
- `retryFailedOperations(userId: string): Promise<RetryResult>` - Manual retry for failed operations
- Dependencies: RPC Batch Manager, Price Service, LP Position Tracker, Error Handler, Retry Manager

[Source: architecture/components.md#rpc-batch-manager]
**Enhanced RPC Batch Manager**:
- `healthCheck(chainIds: number[]): Promise<ProviderHealth[]>` - Check RPC provider connectivity
- `getProviderStatus(): Promise<ProviderStatus>` - Current status of all RPC providers
- Error handling with automatic failover and provider health monitoring

### File Locations
[Source: architecture/unified-project-structure.md#backend-organization]
- **Refresh Service**: `apps/api/src/services/RefreshService.ts` (NEW)
- **Retry Manager**: `apps/api/src/services/RetryManager.ts` (NEW) 
- **Health Check Service**: `apps/api/src/services/HealthCheckService.ts` (NEW)
- **Error Extensions**: `apps/api/src/utils/errors.ts` (EXTEND)
- **Error Boundary**: `apps/web/src/components/ErrorBoundary.tsx` (NEW)
- **Connection Status**: `apps/web/src/components/ConnectionStatus.tsx` (NEW)
- **Loading Skeletons**: `apps/web/src/components/ui/LoadingSkeletons.tsx` (NEW)
- **Portfolio Store**: `apps/web/src/stores/portfolio.ts` (EXTEND)
- **Error Messages**: `packages/shared/src/utils/errorMessages.ts` (NEW)

### Technical Constraints
[Source: architecture/coding-standards.md#critical-fullstack-rules]
- **Error Handling**: All API routes must use the standard error handler with structured error responses
- **State Management**: Never mutate state directly - use proper Zustand patterns for loading states
- **RPC Batching**: Group blockchain calls through RPC Batch Manager, never direct calls for refresh operations
- **BigInt Precision**: All financial calculations during refresh must use BigInt for precision

### External API Integration
[Source: architecture/external-apis.md#error-handling-fallback-strategy]
**RPC Provider Fallback Strategy**:
- Primary: Alchemy API with enhanced features and 300 CU/second rate limits
- Secondary: Infura API for redundancy with 100k requests/day
- Health monitoring: Automatic failover with 99.5% uptime requirement

**Price Data Fallback Strategy**:
- Primary: Moralis Web3 API ($49/month, 25M requests)
- Secondary: DefiLlama (free tier, unlimited requests)
- Tertiary: CoinMarketCap Basic ($29/month, 10K daily requests)

### Error Recovery Patterns
[Source: architecture/error-handling-strategy.md#frontend-error-handling]
**Retry Configuration by Error Type**:
- RPC Failures: 3 attempts with exponential backoff (1s, 2s, 4s)
- Price API Failures: 2 attempts with linear backoff (2s, 4s)
- Network Errors: 5 attempts with exponential backoff up to 30s
- Rate Limit Errors: Single retry after rate limit reset time

**User Experience Patterns**:
- Loading skeletons during initial load and refresh operations
- Error toasts with retry buttons for recoverable errors
- Connection status indicator with provider health visualization
- Graceful degradation when specific providers fail

## Testing

### Testing Standards
[Source: architecture/testing-strategy.md#backend-tests]
**Test File Locations**:
- **Unit Tests**: `apps/api/tests/unit/RefreshService.test.ts`, `apps/api/tests/unit/RetryManager.test.ts`
- **Integration Tests**: `apps/api/tests/integration/portfolio-refresh.test.ts`
- **Frontend Tests**: `apps/web/tests/components/ErrorBoundary.test.tsx`, `apps/web/tests/components/ConnectionStatus.test.tsx`

**Testing Framework**: Vitest + Supertest for API tests, Vitest + Testing Library for frontend
**Test Requirements**:
- Error simulation for all external API failures (RPC, Price APIs)
- Retry logic verification with different error scenarios
- Loading state transitions during refresh operations
- Health check accuracy for provider monitoring
- Circuit breaker behavior under sustained failures
- User notification timing and message accuracy

### Error Simulation Testing
- Mock RPC provider failures with appropriate error codes
- Simulate rate limiting responses from price APIs
- Test network connectivity issues and offline scenarios
- Verify fallback provider switching behavior
- Test concurrent refresh request handling

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-01-09 | 1.0 | Initial story creation with comprehensive error handling and refresh system | Scrum Master |

## Dev Agent Record
*This section will be populated by the development agent during implementation*

### Agent Model Used
*To be filled by dev agent*

### Debug Log References
*To be filled by dev agent*

### Completion Notes List
*To be filled by dev agent*

### File List
*To be filled by dev agent*

## QA Results
*This section will be populated by the QA Agent after development completion*