# Story 1.8: Live LP Position Integration

## Status
Draft

## Story
**As a** DeFi user,
**I want** to see my actual liquidity provider positions replacing mock LP data,
**so that** I can track my real LP investments alongside my token holdings.

## Acceptance Criteria
1. Replace mock LP data with live LP token detection for major protocols
2. LP token balance fetching and position value calculation using real price data
3. Protocol identification and LP pair composition display
4. LP position value calculation using underlying token prices
5. Aggregated LP value integration into portfolio totals
6. Support for detecting LP positions on all three target chains

## Tasks / Subtasks
- [ ] LP Position Detection Implementation (AC: 1, 6)
  - [ ] Implement LP Position Tracker service using detected LP tokens from RPC calls
  - [ ] Add protocol detection logic for Uniswap V2/V3, Trader Joe, Pharaoh, and Blackhole
  - [ ] Create LP token identification system using contract signatures and factory addresses
  - [ ] Build cross-chain LP position detection for Ethereum, Arbitrum, and Avalanche
- [ ] LP Position Value Calculation (AC: 2, 4)
  - [ ] Implement underlying asset calculation using pool reserves and LP token supply
  - [ ] Integrate with existing PriceService for underlying token price data
  - [ ] Add BigInt precision handling for LP position value calculations
  - [ ] Build position performance tracking with fee accumulation data
- [ ] LP Position Data Integration (AC: 3, 5)
  - [ ] Update Portfolio data model to include real LP position data
  - [ ] Modify PortfolioAggregator to integrate LP positions with existing token balances
  - [ ] Update portfolio total value calculation to include LP position values
  - [ ] Add LP position display components to replace mock data in dashboard
- [ ] Frontend LP Position Display (AC: 3)
  - [ ] Update LPPositionCard component to show real protocol and pair data
  - [ ] Add protocol logos and pair composition display
  - [ ] Implement LP position sorting and filtering by protocol/value/chain
  - [ ] Add loading states and error handling for LP position data fetching

## Dev Notes

### Previous Story Insights
From Story 1.6 (Live Token Balance Integration):
- PriceService and PortfolioAggregator services are already implemented
- tRPC portfolio router with getPortfolio and refreshPortfolio endpoints exists
- RPC batching system is operational for efficient blockchain data fetching
- BigInt precision handling is established for financial calculations

### Data Models
[Source: architecture/data-models.md#lpposition]
**LPPosition Interface**:
```typescript
interface LPPosition {
  id: string;
  portfolioId: string;
  protocolId: string;
  poolAddress: string;
  tokenIds: number[];
  underlyingAssets: UnderlyingAsset[];
  totalValueUSD: bigint;
  accumulatedFees: bigint;
  claimableRewards: ClaimableReward[];
  performance: PositionPerformance;
  status: 'active' | 'out-of-range' | 'closed';
  createdAt: Date;
  lastUpdatedAt: Date;
}

interface UnderlyingAsset {
  tokenAddress: string;
  amount: bigint;
  valueUSD: bigint;
  percentage: number;
}
```

### API Specifications
[Source: architecture/api-specification.md#portfolio-router]
**Existing tRPC Portfolio Router** (to be extended):
- `getPortfolio({ userId, chains })` - Currently returns TokenBalance[], needs LP position integration
- `refreshPortfolio({ userId, chainId, forceRefresh })` - Needs LP position refresh capability
- Input validation with Zod schemas and BigInt handling already implemented

### Component Specifications
[Source: architecture/components.md#lp-position-tracker]
**LP Position Tracker Service**:
- `detectLPPositions(walletAddress: string, chainId: number): Promise<LPPosition[]>` - Identify all LP positions
- `calculatePositionPerformance(positionId: string): Promise<PerformanceMetrics>` - Performance and IL analysis
- `getClaimableRewards(positionIds: string[]): Promise<ClaimableReward[]>` - Identify claimable rewards
- Dependencies: Protocol Adapters, RPC Batch Manager, Price Service, Performance Calculator

### File Locations
[Source: architecture/unified-project-structure.md#backend-organization]
- **LP Position Tracker**: `apps/api/src/services/LPPositionTracker.ts` (NEW)
- **Protocol Adapters**: `apps/api/src/adapters/protocols/UniswapAdapter.ts`, etc. (NEW)
- **LP Position Router**: `apps/api/src/routers/lpPosition.ts` (NEW)
- **Shared LP types**: `packages/shared/src/types/portfolio.ts` (EXTEND)
- **LP Position Components**: `apps/web/src/components/lp-positions/LPPositionCard.tsx` (UPDATE)
- **Portfolio Integration**: Update existing `apps/api/src/services/PortfolioAggregator.ts`

### Technical Constraints
[Source: architecture/coding-standards.md#critical-fullstack-rules]
- **BigInt Precision**: All LP position value calculations must use BigInt for financial precision
- **RPC Batching**: Must use RPC Batch Manager for efficient blockchain calls, not direct RPC calls
- **Type Sharing**: LP position types must be defined in packages/shared and imported consistently
- **Price Formatting**: Use shared formatting utilities for extreme LP token values

### External API Integration
[Source: architecture/external-apis.md#cost-optimized-price-data-strategy]
- **Primary Price Data**: Moralis Web3 API (already integrated in Story 1.6)
- **Secondary Price Data**: DefiLlama API as fallback
- **Protocol Data**: Uniswap Subgraph API for historical LP data
- **Rate Limits**: Moralis 25M requests/month, DefiLlama free tier

### Protocol Support Requirements
[Source: architecture/data-models.md#protocol]
**Target Protocols for Epic 1**:
- Uniswap V2/V3 (Ethereum, Arbitrum, Avalanche)
- Trader Joe (Avalanche)
- Pharaoh (Avalanche)
- Blackhole (Avalanche)
**Protocol Contracts**: Factory addresses and router contracts per chain
**Protocol Features**: v2-lp, v3-lp support with configuration per protocol

## Testing

### Testing Standards
[Source: architecture/testing-strategy.md#backend-tests]
**Test File Locations**:
- **Unit Tests**: `apps/api/tests/unit/LPPositionTracker.test.ts`
- **Integration Tests**: `apps/api/tests/integration/lpPosition.test.ts`
- **Frontend Tests**: `apps/web/tests/components/LPPositionCard.test.tsx`

**Testing Framework**: Vitest + Supertest for API tests, Vitest + Testing Library for frontend
**Test Requirements**:
- LP position detection accuracy across protocols
- Value calculation precision with BigInt handling
- Integration with existing portfolio data aggregation
- Error handling for unsupported protocols and network failures

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-01-09 | 1.0 | Initial story creation | Scrum Master |

## Dev Agent Record
*This section will be populated by the development agent during implementation*

### Agent Model Used
*To be filled by dev agent*

### Debug Log References
*To be filled by dev agent*

### Completion Notes List
*To be filled by dev agent*

### File List
*To be filled by dev agent*

## QA Results
*This section will be populated by the QA Agent after development completion*