# Story 1.2: Wallet Connection with Mock Portfolio Display

## Status
Ready for Development

## Story
**As a** DeFi user,
**I want** to securely connect my wallet and see a demo portfolio with sample data,
**so that** I can verify the wallet connection works and preview the portfolio interface.

## Acceptance Criteria
1. Wagmi v2 + VIEM integration supporting MetaMask, WalletConnect, Coinbase Wallet, and Rabby Wallet
2. Wallet connection UI with shadcn/ui components showing connection status
3. Network switching functionality for Ethereum, Arbitrum, and Avalanche
4. Wallet address display with ENS resolution when available
5. Mock portfolio data display (sample tokens and LP positions) when wallet connected
6. Basic dashboard layout showing mock data with proper UI components

## Tasks / Subtasks
- [ ] Set Up Wagmi v2 + VIEM Web3 Integration (AC: 1)
  - [ ] Install and configure wagmi, viem, and wallet connectors
  - [ ] Create wagmi configuration with proper chain definitions
  - [ ] Set up connector instances for MetaMask, WalletConnect, Coinbase Wallet, and Rabby Wallet
  - [ ] Configure RPC providers for each supported chain
- [ ] Build Wallet Connection UI Components (AC: 2)
  - [ ] Create WalletConnection component using shadcn/ui
  - [ ] Add connection status indicators and loading states
  - [ ] Implement disconnect functionality with confirmation
  - [ ] Add error handling for failed connections
- [ ] Implement Multi-Chain Network Switching (AC: 3)
  - [ ] Create NetworkSelector component with chain switching
  - [ ] Add network badges and visual indicators
  - [ ] Handle network switch errors and user rejections
  - [ ] Update UI state based on current network
- [ ] Create Wallet Address Display (AC: 4)
  - [ ] Build AddressDisplay component with ENS support
  - [ ] Add address truncation and copy-to-clipboard functionality
  - [ ] Integrate ENS name resolution using wagmi hooks
  - [ ] Handle ENS resolution errors gracefully
- [ ] Design Mock Portfolio Data System (AC: 5)
  - [ ] Create mock data structures matching Portfolio and TokenBalance interfaces
  - [ ] Generate realistic sample LP positions data
  - [ ] Implement mock data provider service
  - [ ] Add data switching based on connected wallet address
- [ ] Build Basic Dashboard Layout (AC: 6)
  - [ ] Create DashboardLayout component with Header and Sidebar
  - [ ] Implement PortfolioOverview component for mock data display
  - [ ] Add responsive design patterns for mobile and desktop
  - [ ] Integrate wallet connection state with dashboard visibility
- [ ] Testing Implementation (Testing Requirements)
  - [ ] Write component tests for WalletConnection component
  - [ ] Add tests for NetworkSelector functionality
  - [ ] Test ENS resolution with mocked responses
  - [ ] Create integration tests for wallet connection flow
  - [ ] Add E2E tests for complete connection workflow

## Dev Notes

### Previous Story Insights
From Story 1.1 completion:
- Next.js 15.4.5 project structure is established with Turborepo monorepo
- shadcn/ui component library is integrated and configured
- TypeScript configuration is set up with proper path mapping
- Testing infrastructure with Vitest and Testing Library is available
- Apps/web directory structure is ready for new components

### Web3 Technology Stack Requirements
[Source: architecture/tech-stack.md#technology-stack-table]
- **Authentication**: Wagmi v2 for wallet connections with Web3 authentication
- **Blockchain Interaction**: VIEM for type-safe blockchain interactions
- **Supported Wallets**: MetaMask, WalletConnect, Coinbase Wallet, Rabby Wallet integration
- **Chain Support**: Ethereum (1), Arbitrum (42161), Avalanche (43114)

### Component Architecture Guidelines
[Source: architecture/frontend-architecture.md#component-organization]
- **Web3 Components Location**: `apps/web/src/components/web3/`
- **Component Structure**: WalletConnection.tsx, NetworkSelector.tsx, TransactionButton.tsx, AddressDisplay.tsx
- **Layout Components**: `apps/web/src/components/layout/` for DashboardLayout, Header, Sidebar
- **Hook Organization**: `apps/web/src/hooks/` for custom wagmi-based hooks

### Wagmi Configuration Pattern
[Source: architecture/frontend-architecture.md#api-client-setup]
```typescript
// apps/web/src/lib/wagmi.ts configuration pattern
import { createConfig, http } from 'wagmi'
import { mainnet, arbitrum, avalanche } from 'wagmi/chains'
import { metaMask, walletConnect, coinbaseWallet, injected } from 'wagmi/connectors'
// Note: Rabby Wallet uses injected connector with proper detection
```

### Required File Locations
[Source: architecture/unified-project-structure.md#component-organization]
- **Wagmi Config**: `apps/web/src/lib/wagmi.ts`
- **Web3 Components**: `apps/web/src/components/web3/`
  - `WalletConnection.tsx`
  - `NetworkSelector.tsx` 
  - `AddressDisplay.tsx`
- **Layout Components**: `apps/web/src/components/layout/`
  - `DashboardLayout.tsx`
  - `Header.tsx`
  - `Sidebar.tsx`
- **Dashboard Pages**: `apps/web/src/app/(dashboard)/`
- **Mock Data**: `apps/web/src/lib/mockData.ts`

### Data Model Integration Requirements
[Source: architecture/data-models.md#portfolio]
Mock data must follow established TypeScript interfaces:
- **Portfolio Interface**: id, userId, chainId, totalValue (bigint), healthScore, composition
- **TokenBalance Interface**: tokenAddress, balance (bigint), metadata, priceUSD (bigint), valueUSD (bigint)
- **LPPosition Interface**: protocolId, poolAddress, underlyingAssets, totalValueUSD (bigint)

### State Management Architecture
[Source: architecture/frontend-architecture.md#state-management-patterns]
- **Wallet State**: Managed by Wagmi hooks (useAccount, useConnect, useChainId)
- **Dashboard State**: Use Zustand store for layout preferences and chain selection
- **Mock Data State**: Local component state or simple React context

### Routing Architecture Requirements
[Source: architecture/frontend-architecture.md#protected-route-pattern]
- **Protected Routes**: Dashboard routes require wallet connection
- **Connection Page**: `/connect` route for wallet connection flow
- **Route Groups**: Use `(dashboard)` route group for wallet-protected pages
- **Redirect Logic**: Redirect to `/connect` when wallet not connected

### Component Template Standards
[Source: architecture/frontend-architecture.md#component-template]
- **Import Patterns**: shadcn/ui components from `@/components/ui/`
- **Type Safety**: All components must have proper TypeScript interfaces
- **Error Handling**: Loading states, error boundaries, and retry mechanisms
- **Accessibility**: WCAG AA compliance through shadcn/ui components

### Testing Requirements
[Source: architecture/testing-strategy.md#frontend-tests]
- **Test Location**: `apps/web/tests/components/web3/` for Web3 components
- **Testing Framework**: Vitest + @testing-library/react
- **Mock Strategy**: Mock wagmi hooks for isolated component testing
- **E2E Location**: `apps/web/tests/e2e/auth/` for wallet connection flows
- **Component Tests**: Verify rendering, user interactions, and error states
- **Integration Tests**: Test wallet connection flow end-to-end

### Coding Standards Compliance
[Source: architecture/coding-standards.md#critical-fullstack-rules]
- **Type Sharing**: Import shared types from packages/shared if needed
- **Environment Variables**: Access through config objects in lib/config.ts
- **State Updates**: Use proper state management patterns, no direct mutations
- **Component Naming**: PascalCase for components, camelCase for hooks
- **Error Handling**: Standard error patterns with user-friendly messages

### Project Structure Alignment
All story requirements align perfectly with established architecture:
- Wagmi v2 is specified in tech stack for Web3 authentication
- shadcn/ui integration is complete and available for UI components
- Multi-chain support (Ethereum, Arbitrum, Avalanche) matches architecture specs
- Component organization follows established frontend architecture patterns
- Mock data approach allows gradual transition to real data in subsequent stories

## Testing
[Source: architecture/testing-strategy.md]
- **Test Framework**: Vitest for unit tests, @testing-library/react for component testing
- **Test File Locations**: 
  - Component tests: `apps/web/tests/components/web3/`
  - Integration tests: `apps/web/tests/pages/connect.test.tsx`
  - E2E tests: `apps/web/tests/e2e/auth/wallet-connection.spec.ts`
- **Mock Strategy**: Mock wagmi hooks using msw or vitest.mock for isolated testing
- **Testing Requirements**: 
  - Wallet connection component rendering and interaction
  - Network switching functionality
  - ENS resolution with mocked providers
  - Mock portfolio data display
  - Error state handling and retry mechanisms

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-08-07 | 1.0 | Initial story creation with full technical context | Bob (Scrum Master) |
| 2025-08-07 | 1.1 | Added Rabby Wallet support to wallet connector requirements | Bob (Scrum Master) |