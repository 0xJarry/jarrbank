# Story 1.7: API Backend Deployment & Environment Configuration

## Status
Draft

## Story
**As a** DeFi user,
**I want** the API backend services deployed and accessible from the frontend,
**so that** I can actually use the live token balance integration and see real portfolio data instead of experiencing broken functionality.

## Acceptance Criteria
1. Deploy Fastify API server to Railway with health check endpoint operational
2. Configure all required environment variables (Moralis, Alchemy, Redis, etc.) in Railway deployment
3. Set up Railway database connection and verify API can connect to Supabase and Redis
4. Configure tRPC endpoints to be accessible from Vercel-deployed frontend  
5. Set up CI/CD pipeline for automated API deployment from main branch
6. Verify end-to-end API connectivity through health checks and basic portfolio endpoint testing

## Tasks / Subtasks
- [ ] Deploy Fastify API Server to Railway (AC: 1)
  - [ ] Create Railway project and connect to GitHub repository
  - [ ] Configure Railway deployment settings for `apps/api` directory
  - [ ] Set up Railway Dockerfile based on project structure requirements
  - [ ] Deploy initial API server and verify health check endpoint responds
- [ ] Environment Configuration (AC: 2, 3)
  - [ ] Configure Moralis API key in Railway environment variables
  - [ ] Set up Alchemy API key and RPC endpoint configurations
  - [ ] Configure Redis connection URL for Railway Redis add-on or external Redis
  - [ ] Set up Supabase connection variables for database access
  - [ ] Configure CORS settings for Vercel frontend domain access
- [ ] Frontend-Backend Integration (AC: 4)
  - [ ] Update frontend tRPC client configuration with Railway API URL
  - [ ] Configure CORS policies for cross-origin requests from Vercel domain
  - [ ] Test tRPC endpoints are accessible from deployed frontend
  - [ ] Verify portfolio data fetching works end-to-end in deployed environment
- [ ] CI/CD Pipeline Setup (AC: 5)
  - [ ] Configure GitHub Actions workflow for API deployment
  - [ ] Set up Railway CLI integration for automated deployment
  - [ ] Add build and deployment steps for API-specific CI/CD
  - [ ] Configure deployment triggers and branch protection
- [ ] End-to-End Verification (AC: 6)
  - [ ] Test health check endpoint from Railway deployed URL
  - [ ] Verify portfolio.getPortfolio tRPC endpoint works with real wallet data
  - [ ] Test RPC connectivity to Ethereum, Arbitrum, and Avalanche chains
  - [ ] Verify price data fetching from Moralis API works in production environment

## Dev Notes

### Previous Story Insights
From Story 1.6 completion:
- Complete Fastify API server implemented with tRPC v11 integration
- TokenBalanceService, PriceService, and PortfolioAggregator services fully implemented
- tRPC portfolio router with type-safe endpoints completed
- All services tested locally but **not deployed** - this is the critical missing piece
- Redis caching and RPC Batch Manager infrastructure ready for production
- File locations: API server in `apps/api/src/server.ts`, tRPC routers in `apps/api/src/routers/`

### Deployment Architecture
[Source: architecture/deployment-architecture.md]
**Railway Deployment Configuration**:
- Platform: Railway for backend API deployment
- Build Command: `npm run build --scope=api`
- Deployment Method: Docker container with automatic scaling
- Directory: `apps/api/`
- Port: Environment variable `PORT` (Railway provides this)

### Server Configuration
[Source: architecture/backend-architecture.md#server-template]
**Fastify Server Template**:
- Health check endpoint: `/health` endpoint implemented
- Security middleware: Helmet, CORS, rate limiting configured  
- tRPC integration: `/api/trpc` prefix configured
- Environment variables: `HOST`, `PORT`, `FRONTEND_URL` required
- Logger: Pino logging with structured output for Railway logs

### Environment Variables Required
[Source: architecture/external-apis.md]
**Production Environment Configuration**:
```bash
# Price Data APIs (from Story 1.6)
MORALIS_API_KEY=your_moralis_key      # Primary price data source
COINMARKETCAP_API_KEY=your_cmc_key    # Tertiary fallback tier

# RPC Configuration (from Story 1.5) 
ALCHEMY_API_KEY=already_configured
INFURA_PROJECT_ID=already_configured

# Database & Cache
DATABASE_URL=supabase_postgres_url
SUPABASE_SERVICE_ROLE_KEY=supabase_service_key
REDIS_URL=redis_connection_string

# CORS & Security
FRONTEND_URL=https://jarrbank.app      # Or staging URL
NODE_ENV=production
LOG_LEVEL=info

# Railway-specific
HOST=0.0.0.0                          # Required for Railway
PORT=process.env.PORT                  # Railway provides this
```

### CI/CD Pipeline Configuration
[Source: architecture/deployment-architecture.md#ci-cd-pipeline]
**GitHub Actions Deployment**:
```yaml
# Railway deployment section
- name: Deploy to Railway  
  run: |
    railway login --token ${{ secrets.RAILWAY_TOKEN }}
    railway deploy --service api --directory ./apps/api
```

### Dockerfile Requirements
[Source: architecture/unified-project-structure.md#backend-organization]
**Railway Deployment Docker**:
- Location: `apps/api/Dockerfile`
- Node.js 20 LTS base image
- Turborepo-compatible build process
- Health check integration
- Port exposure for Railway

### File Locations
[Source: architecture/unified-project-structure.md#backend-organization]
- **API Server**: `apps/api/src/server.ts` - Main Fastify server entry point
- **Docker Configuration**: `apps/api/Dockerfile` - Railway deployment configuration
- **Environment Template**: `apps/api/.env.example` - Environment variable template
- **CI/CD Workflow**: `.github/workflows/deploy-prod.yml` - Deployment automation
- **Frontend tRPC Config**: `apps/web/src/lib/trpc.ts` - Client configuration for Railway URL

### Frontend Integration Requirements
[Source: architecture/frontend-architecture.md#component-template]
**tRPC Client Configuration**:
- Base URL update: Change from `http://localhost:3001` to Railway API URL
- Environment variable: `NEXT_PUBLIC_API_URL` for dynamic API endpoint
- CORS configuration: Ensure Railway API accepts requests from Vercel domain

### Testing
[Source: architecture/testing-strategy.md#test-organization]

**Deployment Verification Tests**:
- Health check endpoint: Verify `/health` returns 200 status with service health data
- tRPC endpoint testing: Test `portfolio.getPortfolio` with real wallet address
- RPC connectivity: Verify blockchain connections to all three chains work
- Price API integration: Confirm Moralis API calls succeed in production environment
- CORS functionality: Test cross-origin requests from deployed frontend domain

**Test Framework**: Manual testing for deployment verification, automated health checks in CI/CD

**Test Requirements**:
- API endpoint accessibility from deployed frontend
- Database connectivity verification
- External API integration confirmation (Moralis, Alchemy)
- Error handling for network failures and API rate limits

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-08-09 | 1.0 | Initial story creation for critical API deployment | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used
[To be filled by development agent]

### Debug Log References  
[To be filled by development agent]

### Completion Notes List
[To be filled by development agent]

### File List
[To be filled by development agent]

## QA Results
[To be filled by QA agent]